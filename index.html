<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Geavanceerde Audio Remix App</title>
<style>
body { font-family: sans-serif; padding: 20px; }
button, input { margin: 5px; }
h1 { margin-bottom: 20px; }
</style>
</head>
<body>

<h1>Geavanceerde Audio Remix App</h1>

<input type="file" id="audioFile" accept="audio/*"><br><br>

<button id="playBtn">Play</button>
<button id="pauseBtn">Pause</button>
<button id="stopBtn">Stop</button>
<button id="loopBtn">Toggle Loop</button><br><br>

<button id="echoBtn">Echo</button>
<button id="reverbBtn">Reverb</button>
<button id="lowPassBtn">Low-pass Filter</button>
<button id="highPassBtn">High-pass Filter</button>
<button id="speedUpBtn">Speed +</button>
<button id="slowDownBtn">Speed -</button><br><br>

<label>Volume: </label><input type="range" id="volumeSlider" min="0" max="2" step="0.01" value="1"><br><br>

<button id="downloadBtn">Download Remix</button>

<script>
let audioContext = new (window.AudioContext || window.webkitAudioContext)();
let source, buffer;
let gainNode = audioContext.createGain();
let echoNode = audioContext.createDelay();
echoNode.delayTime.value = 0.25;
let lowPassFilter = audioContext.createBiquadFilter();
lowPassFilter.type = "lowpass";
let highPassFilter = audioContext.createBiquadFilter();
highPassFilter.type = "highpass";
let convolver = audioContext.createConvolver(); // Reverb
let isLooping = false;
let playbackRate = 1;

document.getElementById('audioFile').addEventListener('change', function(e){
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = function(ev){
        audioContext.decodeAudioData(ev.target.result, function(buf){
            buffer = buf;
            alert("Audio geladen!");
        });
    };
    reader.readAsArrayBuffer(file);
});

function connectNodes(){
    if(!source) return;
    source.disconnect();
    let currentNode = source;

    // Check active effects
    if(echoActive) { currentNode.connect(echoNode); currentNode = echoNode; }
    if(reverbActive) { currentNode.connect(convolver); currentNode = convolver; }
    if(lowPassActive) { currentNode.connect(lowPassFilter); currentNode = lowPassFilter; }
    if(highPassActive) { currentNode.connect(highPassFilter); currentNode = highPassFilter; }

    currentNode.connect(gainNode);
    gainNode.connect(audioContext.destination);
}

function playAudio(){
    if(!buffer) return;
    source = audioContext.createBufferSource();
    source.buffer = buffer;
    source.loop = isLooping;
    source.playbackRate.value = playbackRate;
    connectNodes();
    source.start(0);
}

function stopAudio(){
    if(source){
        source.stop();
        source = null;
    }
}

function pauseAudio(){
    if(audioContext.state === 'running'){
        audioContext.suspend();
    } else {
        audioContext.resume();
    }
}

document.getElementById('playBtn').onclick = playAudio;
document.getElementById('stopBtn').onclick = stopAudio;
document.getElementById('pauseBtn').onclick = pauseAudio;
document.getElementById('loopBtn').onclick = function(){ isLooping = !isLooping; alert("Looping: " + isLooping); };

// Effect toggles
let echoActive=false, reverbActive=false, lowPassActive=false, highPassActive=false;

document.getElementById('echoBtn').onclick = function(){ echoActive=!echoActive; alert("Echo: " + echoActive); };
document.getElementById('reverbBtn').onclick = function(){ reverbActive=!reverbActive; alert("Reverb: " + reverbActive); };
document.getElementById('lowPassBtn').onclick = function(){ lowPassActive=!lowPassActive; alert("Low-pass: " + lowPassActive); };
document.getElementById('highPassBtn').onclick = function(){ highPassActive=!highPassActive; alert("High-pass: " + highPassActive); };

// Speed control
document.getElementById('speedUpBtn').onclick = function(){ playbackRate += 0.1; alert("Speed: " + playbackRate.toFixed(1)); };
document.getElementById('slowDownBtn').onclick = function(){ playbackRate -= 0.1; if(playbackRate<0.1) playbackRate=0.1; alert("Speed: " + playbackRate.toFixed(1)); };

// Volume
document.getElementById('volumeSlider').addEventListener('input', function(){
    gainNode.gain.value = this.value;
});

// Download functie (WAV)
document.getElementById('downloadBtn').onclick = function(){
    if(!buffer) return;
    let offlineContext = new OfflineAudioContext(buffer.numberOfChannels, buffer.length, buffer.sampleRate);
    let offlineSource = offlineContext.createBufferSource();
    offlineSource.buffer = buffer;

    // Connect effects for export
    let currentNode = offlineSource;
    if(echoActive){ 
        let delay = offlineContext.createDelay();
        delay.delayTime.value = 0.25; 
        currentNode.connect(delay); 
        currentNode = delay;
    }
    if(lowPassActive){ 
        let lp = offlineContext.createBiquadFilter(); lp.type="lowpass"; 
        currentNode.connect(lp); currentNode = lp;
    }
    if(highPassActive){ 
        let hp = offlineContext.createBiquadFilter(); hp.type="highpass"; 
        currentNode.connect(hp); currentNode = hp;
    }

    currentNode.connect(offlineContext.destination);
    offlineSource.start();

    offlineContext.startRendering().then(renderedBuffer => {
        let wavBlob = bufferToWave(renderedBuffer, renderedBuffer.length);
        let url = URL.createObjectURL(wavBlob);
        let a = document.createElement('a');
        a.href = url;
        a.download = "remix.wav";
        a.click();
    });
};

// WAV converter
function bufferToWave(abuffer, len) {
    let numOfChan = abuffer.numberOfChannels,
        length = len * numOfChan * 2 + 44,
        buffer = new ArrayBuffer(length),
        view = new DataView(buffer),
        channels = [], i, sample,
        offset = 0,
        pos = 0;

    setUint32(0x46464952); setUint32(length - 8); setUint32(0x45564157);
    setUint32(0x20746d66); setUint32(16); setUint16(1); setUint16(numOfChan);
    setUint32(abuffer.sampleRate); setUint32(abuffer.sampleRate * 2 * numOfChan);
    setUint16(numOfChan * 2); setUint16(16); setUint32(0x61746164);
    setUint32(length - pos - 4);

    for(i=0;i<numOfChan;i++) channels.push(abuffer.getChannelData(i));

    while(pos<length){
        for(i=0;i<numOfChan;i++){
            sample=Math.max(-1,Math.min(1,channels[i][offset]));
            sample=(0.5+sample*0.5)*65535;
            view.setUint16(pos,sample,true);
            pos+=2;
        }
        offset++;
    }

    return new Blob([buffer], {type:"audio/wav"});

    function setUint16(data){ view.setUint16(pos,data,true); pos+=2; }
    function setUint32(data){ view.setUint32(pos,data,true); pos+=4; }
}
</script>

</body>
</html>

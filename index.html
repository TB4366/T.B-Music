<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Agar.io skins — Demo (UID + Xsolla redirect)</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#f6f8fb;color:#0b1220;padding:18px}
  .card{max-width:1100px;margin:12px auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  input[type=text]{padding:8px;border-radius:6px;border:1px solid #d8e0ea;width:100%}
  .skins{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .skin{width:220px;padding:12px;border-radius:8px;border:1px solid #e6eef8;background:#fbfdff;cursor:pointer;box-shadow:0 2px 8px rgba(2,6,23,0.04)}
  .skin.selected{outline:3px solid #2b6cb0}
  button{background:#2b6cb0;color:white;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
  .note{font-size:0.9rem;color:#4b5563;margin-top:8px}
  pre{max-height:260px;overflow:auto;background:#0b1220;color:#e6eef8;padding:10px;border-radius:8px}
  .danger{color:#b91c1c;font-weight:700}
</style>
</head>
<body>
  <div class="card">
    <h2>Agar.io — Koop skin (demo)</h2>
    <p class="note">Voer je officiële player UID in. Deze demo opent Xsolla met metadata. <strong>LET OP:</strong> de skin wordt alleen echt aan het account toegekend als jouw backend en Miniclip samen de webhook + toekenning verzorgen; deze HTML doet dat niet.</p>

    <div class="row">
      <div style="flex:1;min-width:220px">
        <label for="uid">Player UID (verplicht)</label>
        <input id="uid" type="text" placeholder="bv. player-12345">
      </div>
      <div style="width:520px;min-width:220px">
        <label for="configUrl">Config URL</label>
        <input id="configUrl" type="text" value="https://configs-web.agario.miniclippt.com/live/v15/10850/GameConfiguration.json">
      </div>
    </div>

    <div style="margin-top:10px">
      <button id="load">Laad skins</button>
      <span style="margin-left:12px;color:#6b7280">Als fetch faalt door CORS wordt een proxy gebruikt (alleen voor test).</span>
    </div>

    <div id="viewer" style="margin-top:18px"></div>

    <div style="margin-top:18px">
      <button id="buy">Accepteer & Betaal (open Xsolla)</button>
      <div id="status" style="margin-top:8px;color:#374151"></div>
      <p class="danger">Belangrijk: deze pagina stuurt metadata naar Xsolla maar voert geen account-toekenning uit. Voor echte toekenning is Miniclip's server nodig.</p>
    </div>

    <hr/>
    <h4>Volledige JSON (debug)</h4>
    <pre id="jsonRaw">Geen config geladen.</pre>
  </div>

<script>
(async function(){
  const loadBtn = document.getElementById('load');
  const viewer = document.getElementById('viewer');
  const jsonRaw = document.getElementById('jsonRaw');
  const buyBtn = document.getElementById('buy');
  const status = document.getElementById('status');
  const uidInput = document.getElementById('uid');
  const configUrlInput = document.getElementById('configUrl');

  const XSOLLA_BASE = 'https://secure.xsolla.com/paystation3/desktop/list/?access_token=ryolz2LhiI7Zeb0G0BliTvHwx9Si0LiA_lc_en&preferences=eyJpdGVtUHJvbW90aW9ucyI6IltdIn0-&sessional=eyJoaXN0b3J5IjpbWyJzYXZlZG1ldGhvZCJdLFsibGlzdCIsdHJ1ZV1dfQ--';

  let skins = [], selected = null;

  loadBtn.addEventListener('click', async () => {
    viewer.innerHTML = '<p>Laden…</p>';
    jsonRaw.textContent = 'Laden…';
    selected = null;
    skins = [];

    const url = configUrlInput.value.trim();
    if (!url) { viewer.innerHTML = '<p>Voer een geldige URL in.</p>'; return; }

    // Probeer eerst directe fetch, fallback op proxy
    async function tryDirect(u) {
      const r = await fetch(u, { cache: 'no-store' });
      if (!r.ok) throw new Error('Direct fetch gaf status ' + r.status);
      return await r.json();
    }
    async function tryProxy(u) {
      const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(u);
      const r = await fetch(proxy, { cache: 'no-store' });
      if (!r.ok) throw new Error('Proxy fetch gaf status ' + r.status);
      return await r.json();
    }

    let cfg;
    try { cfg = await tryDirect(url); }
    catch (err) {
      console.warn('Direct fetch failed, proxying:', err.message);
      try { cfg = await tryProxy(url); }
      catch (err2) {
        viewer.innerHTML = `<p style="color:crimson">Kon config niet laden: ${err2.message}</p>`;
        jsonRaw.textContent = 'Kon JSON niet laden: ' + err2.message;
        return;
      }
    }

    jsonRaw.textContent = JSON.stringify(cfg, null, 2);
    // recursief skins zoeken
    skins = findSkins(cfg);
    skins = normalizeSkins(skins);
    renderSkins();
  });

  buyBtn.addEventListener('click', () => {
    status.textContent = '';
    const uid = uidInput.value.trim();
    if (!uid) { status.textContent = 'Vul eerst je player UID in.'; return; }
    if (!selected) { status.textContent = 'Selecteer eerst een skin.'; return; }

    const metadata = encodeURIComponent(JSON.stringify({
      uid: uid,
      productId: selected.productId,
      gameplayId: selected.gameplayId,
      price: selected.price
    }));

    const sep = XSOLLA_BASE.includes('?') ? '&' : '?';
    const finalUrl = XSOLLA_BASE + sep + 'metadata=' + metadata;

    // Open Xsolla in nieuw tabblad
    const w = window.open(finalUrl, '_blank');
    if (!w) { status.textContent = 'Popup geblokkeerd — sta popups toe.'; return; }
    status.innerHTML = 'Xsolla geopend in nieuw tabblad. Voltooi daar de betaling. (Deze HTML kent geen skins toe.)';
  });

  // helpers
  function findSkins(obj){
    const found = [];
    (function r(o){
      if (!o || typeof o !== 'object') return;
      if (o.productId || o.skinType || o.image) {
        found.push({
          productId: o.productId,
          gameplayId: o.gameplayId,
          image: o.image,
          skinType: o.skinType,
          price: o.price,
          cellColor: o.cellColor
        });
      }
      for (const k of Object.keys(o)) r(o[k]);
    })(obj);
    return found;
  }

  function normalizeSkins(list){
    const out = [];
    const seen = new Set();
    for (const s of list){
      const key = s.productId || JSON.stringify(s);
      if (seen.has(key)) continue;
      seen.add(key);
      out.push({
        productId: s.productId || null,
        gameplayId: s.gameplayId || null,
        image: s.image || null,
        skinType: s.skinType || null,
        price: (s.price != null ? Number(s.price) : (s.defaultPrice != null ? Number(s.defaultPrice) : 2.99)),
        cellColor: s.cellColor || null
      });
    }
    return out;
  }

  function renderSkins(){
    viewer.innerHTML = '';
    if (!skins.length) { viewer.innerHTML = '<p>Geen skins gevonden.</p>'; return; }
    const grid = document.createElement('div');
    grid.style.display = 'flex';
    grid.style.flexWrap = 'wrap';
    grid.style.gap = '12px';
    skins.forEach((s, idx) => {
      const card = document.createElement('div');
      card.className = 'skin';
      card.style.width = '220px';
      card.style.boxSizing = 'border-box';
      card.innerHTML = `
        <div style="height:110px;display:flex;align-items:center;justify-content:center;margin-bottom:8px">
          ${s.image ? `<img src="${fixImageUrl(s.image)}" alt="${escapeHtml(s.productId||'')}" style="max-width:100%;max-height:100%">` : '<div style="color:#9ca3af">geen afbeelding</div>'}
        </div>
        <div><strong>${escapeHtml(s.productId||'onbekend')}</strong></div>
        <div style="font-size:0.9rem;color:#6b7280">gameplayId: ${s.gameplayId ?? '-'} — ${s.skinType ?? '-'}</div>
        <div style="margin-top:6px;font-weight:700">€${Number(s.price).toFixed(2)}</div>
      `;
      card.addEventListener('click', () => {
        document.querySelectorAll('.skin').forEach(el => el.classList.remove('selected'));
        card.classList.add('selected');
        selected = s;
        status.textContent = `Geselecteerd: ${s.productId} — €${Number(s.price).toFixed(2)}`;
      });
      grid.appendChild(card);
    });
    viewer.appendChild(grid);
  }

  function fixImageUrl(src){
    if (!src) return '';
    if (/^https?:\/\//i.test(src)) return src;
    try {
      const cfgUrl = new URL(configUrlInput.value.trim());
      const basePath = cfgUrl.origin + cfgUrl.pathname.substring(0, cfgUrl.pathname.lastIndexOf('/') + 1);
      return basePath + src;
    } catch(e) {
      return 'https://configs-web.agario.miniclippt.com/live/v15/10850/' + src;
    }
  }

  function escapeHtml(s){ if (!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
})();
</script>
</body>
</html>

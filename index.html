<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Game Helper</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
    :root {
        --bg-light: #f5f5f5;
        --bg-dark: #1e1e1e;
        --card-light: #ffffff;
        --card-dark: #2a2a2a;
        --text-light: #000000;
        --text-dark: #ffffff;
        --primary: #007bff;
    }
    body {
        margin: 0;
        font-family: 'Inter', sans-serif;
        background: var(--bg-light);
        color: var(--text-light);
        transition: 0.3s;
    }
    body.dark {
        background: var(--bg-dark);
        color: var(--text-dark);
    }
    .container {
        max-width: 450px;
        margin: 40px auto;
        background: var(--card-light);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: 0.3s;
    }
    body.dark .container {
        background: var(--card-dark);
        box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    h2 {
        margin-top: 0;
        text-align: center;
    }
    label {
        display: block;
        margin-top: 15px;
        font-weight: 500;
    }
    input, select, button {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        margin-top: 5px;
        font-size: 14px;
        box-sizing: border-box;
    }
    body.dark input, body.dark select {
        background: #3a3a3a;
        color: #fff;
        border: 1px solid #444;
    }
    .row {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
    button {
        background: var(--primary);
        color: white;
        border: none;
        cursor: pointer;
        font-weight: 600;
    }
    button:hover {
        opacity: 0.9;
    }
    .small {
        font-size: 12px;
        opacity: 0.8;
        margin-top: 10px;
    }
    .top-bar {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        align-items: center;
    }
    .lang-buttons button {
        width: auto;
        padding: 6px 10px;
        margin-left: 5px;
        border: 1px solid #ccc;
        background: transparent;
        color: inherit;
    }
    .lang-buttons button.active {
        border-color: var(--primary);
        font-weight: 600;
    }
    .theme-toggle {
        cursor: pointer;
        font-size: 20px;
        user-select: none;
    }
    .warning {
        color: #b33;
        font-weight: 600;
        margin-top: 8px;
    }
</style>
</head>
<body>
<div class="container">
    <div class="top-bar">
        <div class="lang-buttons">
            <button id="lang-nl" class="active">🇳🇱 NL</button>
            <button id="lang-en">🇬🇧 EN</button>
        </div>
        <div class="theme-toggle" id="themeToggle">🌙</div>
    </div>
    
    <h2 id="title">Start een Game Helper</h2>

    <label id="label-uid">Console ID / Skin Key (UID)</label>
    <input id="uid" placeholder="Plak je UID hier" autocomplete="off" inputmode="text">
    <label><input type="checkbox" id="hideKey" checked> <span id="label-hidekey">Verberg geheime sleutel</span></label>

    <div class="row">
        <button id="verifyBtn">Controleer & Koppel UID</button>
    </div>

    <div id="status" style="margin-top:10px; font-weight:500;"></div>
    <div id="warning" class="warning" style="display:none;"></div>

    <label id="label-region">Kies Bot Regio</label>
    <select id="region">
        <option>ME South 1</option>
        <option>EU West</option>
        <option>US East</option>
    </select>

    <label id="label-mode">Kies Bot Game Modus</label>
    <select id="mode">
        <option>Burst</option>
        <option>Classic</option>
    </select>

    <label id="label-botname">Bot Naam invullen</label>
    <input id="botName" placeholder="bijv. T.B">

    <label id="label-party">Bot Party (link)</label>
    <input id="party" placeholder="https://r.agar.io/?party=...">

    <button id="startBotBtn" style="margin-top:20px;">Start Bot</button>

    <p class="small" id="note">Voor veiligheid wordt alleen een hash van je UID opgeslagen en verzonden.</p>
</div>

<script>
/*
  Veiligheids- en privacyverbeteringen:
  - Client-side hashing (SHA-256) via Web Crypto API vóór verzending.
  - Geen plain UID in localStorage; alleen hash.
  - UID-extractie: zoekt naar UUID-achtige substring(s) in de invoer en gebruikt deze.
*/

const translations = {
    en: {
        title: "Start a Game Helper",
        uid: "Console ID / Skin Key (UID)",
        hideKey: "Hide secret key",
        verify: "Check & Link UID",
        region: "Choose Bot Region",
        mode: "Set Bot Game Mode",
        botName: "Put Bot Name",
        party: "Put Bot Party (link)",
        start: "Start Bot",
        note: "For security, only a hash of your UID is stored on the server.",
        placeholderUid: "Paste your UID here",
        placeholderBotName: "e.g. T.B",
        placeholderParty: "https://r.agar.io/?party=...",
        errorNoUid: "Please enter a UID first.",
        multipleUids: "Multiple UID-like strings detected. Using the first one found."
    },
    nl: {
        title: "Start een Game Helper",
        uid: "Console ID / Skin Key (UID)",
        hideKey: "Verberg geheime sleutel",
        verify: "Controleer & Koppel UID",
        region: "Kies Bot Regio",
        mode: "Kies Bot Game Modus",
        botName: "Bot Naam invullen",
        party: "Bot Party (link)",
        start: "Start Bot",
        note: "Voor veiligheid wordt alleen een hash van je UID opgeslagen.",
        placeholderUid: "Plak je UID hier",
        placeholderBotName: "bijv. T.B",
        placeholderParty: "https://r.agar.io/?party=...",
        errorNoUid: "Voer eerst een UID in.",
        multipleUids: "Meerdere UID-achtige strings gedetecteerd. Gebruik de eerste."
    }
};

let currentLang = localStorage.getItem('lang') || 'nl';
let linkedUser = JSON.parse(localStorage.getItem('linkedUser') || 'null');

function applyLanguage() {
    const t = translations[currentLang];
    document.getElementById('title').textContent = t.title;
    document.getElementById('label-uid').textContent = t.uid;
    document.getElementById('label-hidekey').textContent = t.hideKey;
    document.getElementById('verifyBtn').textContent = t.verify;
    document.getElementById('label-region').textContent = t.region;
    document.getElementById('label-mode').textContent = t.mode;
    document.getElementById('label-botname').textContent = t.botName;
    document.getElementById('label-party').textContent = t.party;
    document.getElementById('startBotBtn').textContent = t.start;
    document.getElementById('note').textContent = t.note;
    document.getElementById('uid').placeholder = t.placeholderUid;
    document.getElementById('botName').placeholder = t.placeholderBotName;
    document.getElementById('party').placeholder = t.placeholderParty;

    document.getElementById('lang-en').classList.toggle('active', currentLang === 'en');
    document.getElementById('lang-nl').classList.toggle('active', currentLang === 'nl');
}
document.getElementById('lang-en').onclick = () => { currentLang = 'en'; localStorage.setItem('lang', 'en'); applyLanguage(); };
document.getElementById('lang-nl').onclick = () => { currentLang = 'nl'; localStorage.setItem('lang', 'nl'); applyLanguage(); };

function toggleTheme() {
    const body = document.body;
    body.classList.toggle('dark');
    const isDark = body.classList.contains('dark');
    document.getElementById('themeToggle').textContent = isDark ? '☀️' : '🌙';
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
}
document.getElementById('themeToggle').onclick = toggleTheme;

(function initTheme() {
    const saved = localStorage.getItem('theme');
    if (saved === 'dark') {
        document.body.classList.add('dark');
        document.getElementById('themeToggle').textContent = '☀️';
    } else {
        document.getElementById('themeToggle').textContent = '🌙';
    }
})();

applyLanguage();

// toggle masked input when hideKey checkbox changes
const uidInput = document.getElementById('uid');
const hideKeyCheckbox = document.getElementById('hideKey');
hideKeyCheckbox.addEventListener('change', () => {
    // Use password type to mask; text to show.
    uidInput.type = hideKeyCheckbox.checked ? 'password' : 'text';
});
// initialize
uidInput.type = hideKeyCheckbox.checked ? 'password' : 'text';

async function postJSON(url, data) {
    const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    return await res.json();
}

const statusDiv = document.getElementById('status');
const warnDiv = document.getElementById('warning');

/**
 * Finds UUID-like substrings in input.
 * Pattern matches typical UUID v4-like: 8-4-4-4-12 hex groups.
 */
function extractUUIDs(text) {
    if (!text) return [];
    const regex = /[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}/g;
    return text.match(regex) || [];
}

/**
 * SHA-256 hash using Web Crypto API.
 * Returns hex string.
 */
async function sha256Hex(message) {
    const encoder = new TextEncoder();
    const data = encoder.encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    return hashHex;
}

document.getElementById('verifyBtn').onclick = async () => {
    warnDiv.style.display = 'none';
    const raw = uidInput.value.trim();
    if (!raw) {
        statusDiv.textContent = translations[currentLang].errorNoUid;
        return;
    }

    statusDiv.textContent = "Bezig...";
    try {
        // extract UUID-like substrings if present
        const found = extractUUIDs(raw);
        let uidToUse = raw;
        if (found.length >= 1) {
            // if multiple found, warn user and use the first one
            if (found.length > 1) {
                warnDiv.textContent = translations[currentLang].multipleUids;
                warnDiv.style.display = 'block';
            }
            uidToUse = found[0];
        } else {
            // no UUID pattern found — we'll still allow using the raw input but warn the user
            // keep this behavior: it's up to user to paste valid identifier
            // (we do NOT send raw UID to server — only hash)
        }

        // Hash the uidToUse client-side
        const hashed = await sha256Hex(uidToUse);

        // Send only the hash to server
        const resp = await postJSON('/api/verify-uid', { uidHash: hashed });
        if (resp.ok) {
            // store only minimal info locally and never the raw UID
            linkedUser = {
                id: resp.user.id,
                uidHash: hashed,
                display: resp.user.display || null
            };
            localStorage.setItem('linkedUser', JSON.stringify(linkedUser));
            statusDiv.textContent = "✅ UID gekoppeld! User ID: " + resp.user.id;
        } else {
            statusDiv.textContent = "❌ " + (resp.message || "Verificatie mislukt.");
        }
    } catch (e) {
        console.error(e);
        statusDiv.textContent = "❌ Server error";
    }
};

document.getElementById('startBotBtn').onclick = async () => {
    warnDiv.style.display = 'none';
    if (!linkedUser) {
        statusDiv.textContent = "❌ UID niet gekoppeld.";
        return;
    }

    const data = {
        userId: linkedUser.id,
        // we still avoid sending any raw UID; if server needs proof it should use the stored hash
        uidHash: linkedUser.uidHash,
        botName: document.getElementById('botName').value.trim(),
        region: document.getElementById('region').value,
        mode: document.getElementById('mode').value,
        party: document.getElementById('party').value.trim()
    };

    statusDiv.textContent = "...";
    try {
        const resp = await postJSON('/api/start-bot', data);
        if (resp.ok) {
            statusDiv.textContent = "✅ Bot gestart! Session ID: " + resp.sessionId;
        } else {
            statusDiv.textContent = "❌ " + (resp.message || "Kon bot niet starten.");
        }
    } catch (e) {
        console.error(e);
        statusDiv.textContent = "❌ Server error";
    }
};
</script>
</body>
</html>

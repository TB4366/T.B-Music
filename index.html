<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Agar.io — Xsolla redirect demo (UID vereist)</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;background:#f6f8fb;color:#0b1220;padding:18px}
  .card{max-width:980px;margin:10px auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  label{font-weight:600}
  input[type=text]{padding:8px;border-radius:6px;border:1px solid #d8e0ea;width:100%}
  .skins{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .skin{width:200px;padding:10px;border-radius:8px;border:1px solid #e6eef8;background:#fbfdff;cursor:pointer}
  .skin.selected{outline:3px solid #2b6cb0}
  button{background:#2b6cb0;color:white;border:0;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
  .note{font-size:0.9rem;color:#4b5563;margin-top:8px}
  pre{max-height:220px;overflow:auto;background:#0b1220;color:#e6eef8;padding:10px;border-radius:8px}
  .danger{color:#8a2b2b;font-weight:700}
</style>
</head>
<body>
  <div class="card">
    <h2>Agar.io Config Viewer + Xsolla‑redirect (demo)</h2>
    <p class="note">Voer hieronder je officiële <strong>player UID</strong> in. Deze demo stuurt je naar Xsolla met metadata; <em>hij kent geen skins toe</em> — toekenning vereist een beveiligde backend + Miniclip API.</p>

    <div class="row" style="margin-top:6px;">
      <div style="flex:1;">
        <label for="uid">Player UID (verplicht)</label>
        <input id="uid" type="text" placeholder="bv. player-12345">
      </div>
      <div style="width:320px;">
        <label for="configUrl">Config URL</label>
        <input id="configUrl" type="text" value="https://configs-web.agario.miniclippt.com/live/v15/10850/GameConfiguration.json">
      </div>
    </div>

    <div style="margin-top:12px;">
      <button id="load">Laad config en toon skins</button>
      <span style="margin-left:10px;color:#6b7280">Let op CORS: als fetch faalt, download JSON en open lokaal of via proxy.</span>
    </div>

    <section id="viewer" style="margin-top:16px;"></section>

    <hr/>

    <div class="card" style="background:#f8fafc;">
      <h3>Xsolla redirect instellingen</h3>
      <label for="xsollaUrl">Xsolla Paystation URL</label>
      <input id="xsollaUrl" type="text" style="width:100%;" value="https://secure.xsolla.com/paystation3/desktop/list/?access_token=ryolz2LhiI7Zeb0G0BliTvHwx9Si0LiA_lc_en&preferences=eyJpdGVtUHJvbW90aW9ucyI6IltdIn0-&sessional=eyJoaXN0b3J5IjpbWyJzYXZlZG1ldGhvZCJdLFsibGlzdCIsdHJ1ZV1dfQ--">
      <p class="note">Dit is de door jou opgegeven Xsolla‑URL. De demo voegt client‑metadata toe als query‑parameter <code>metadata</code> (URI‑encoded JSON met uid/productId/gameplayId).</p>
    </div>

    <div style="margin-top:14px;">
      <button id="buy" style="display:block">Accepteer geselecteerde skin en ga naar Xsolla</button>
      <p id="status" class="note"></p>
      <p class="note danger">BELANGRIJK: deze demo voert géén server‑side toekenning uit. Zorg dat jouw backend Xsolla‑webhooks verwerkt en dat Miniclip officieel jouw partner‑API levert voordat je automatische toekenning inschakelt.</p>
      <details style="margin-top:8px;">
        <summary>Hoe werkt dit technisch?</summary>
        <ol>
          <li>Frontend stuurt gebruiker naar Xsolla met metadata (UID + skin).</li>
          <li>Xsola behandelt betaling (sandbox of productie afhankelijk van token/URL).</li>
          <li>Jouw backend ontvangt Xsolla webhook, valideert deze en roept Miniclip toe‑kenning API aan (alleen als Miniclip je daartoe machtigt).</li>
        </ol>
      </details>
    </div>

    <hr/>
    <h4>Volledige JSON (voor debugging)</h4>
    <pre id="jsonRaw">Geen config geladen.</pre>
  </div>

<script>
(async function(){
  const loadBtn = document.getElementById('load');
  const viewer = document.getElementById('viewer');
  const jsonRaw = document.getElementById('jsonRaw');
  const buyBtn = document.getElementById('buy');
  const status = document.getElementById('status');

  let skins = []; // gevonden skins
  let selected = null;

  loadBtn.addEventListener('click', async () => {
    viewer.innerHTML = '<p>Laden…</p>';
    const url = document.getElementById('configUrl').value.trim();
    if (!url) { viewer.innerHTML = '<p>Vul een geldige URL in.</p>'; return; }
    try {
      const r = await fetch(url, {cache:'no-store'});
      if (!r.ok) throw new Error('Status ' + r.status);
      const cfg = await r.json();
      jsonRaw.textContent = JSON.stringify(cfg, null, 2);
      skins = findSkins(cfg);
      renderSkins(skins);
    } catch (err) {
      viewer.innerHTML = `<p style="color:crimson">Kon config niet laden: ${err.message}</p>
        <p class="note">CORS kan fetch blokkeren. Download het JSON bestand handmatig of serveer via een kleine proxy/webserver.</p>`;
      jsonRaw.textContent = 'Kon JSON niet laden: ' + err.message;
    }
  });

  function renderSkins(list){
    viewer.innerHTML = '';
    const wrap = document.createElement('div');
    wrap.className = 'skins';
    if (!list.length) {
      viewer.innerHTML = '<p>Geen skins gevonden in deze config.</p>';
      return;
    }
    list.forEach(s=>{
      const el = document.createElement('div');
      el.className = 'skin';
      el.innerHTML = `<div style="height:80px;display:flex;align-items:center;justify-content:center;margin-bottom:6px">
          ${s.image ? `<img src="${sanitizeImg(s.image)}" alt="${escapeHtml(s.productId||'')}" style="max-width:100%;max-height:100%"/>` : '<div style="color:#9ca3af">no image</div>'}
        </div>
        <div><strong>${escapeHtml(s.productId || 'onbekend')}</strong></div>
        <div style="font-size:0.9rem;color:#6b7280">gameplayId: ${s.gameplayId ?? '-'} — ${s.skinType ?? '-'}</div>
        <div style="font-size:0.85rem;color:#374151">prijs: ${s.price ?? '-'}</div>`;
      el.addEventListener('click', ()=> {
        document.querySelectorAll('.skin').forEach(x=>x.classList.remove('selected'));
        el.classList.add('selected');
        selected = s;
        status.textContent = `Geselecteerd: ${s.productId || 'onbekend'}`;
      });
      wrap.appendChild(el);
    });
    viewer.appendChild(wrap);
  }

  buyBtn.addEventListener('click', ()=> {
    status.textContent = '';
    const uid = document.getElementById('uid').value.trim();
    if (!uid) { status.textContent = 'Vul eerst je player UID in.'; return; }
    if (!selected) { status.textContent = 'Selecteer eerst een skin.'; return; }

    // Bouw metadata met uid/product/gameplay
    const metadata = { uid: uid, productId: selected.productId, gameplayId: selected.gameplayId, price: selected.price };

    // Standaard Xsolla URL uit input
    let base = document.getElementById('xsollaUrl').value.trim();
    if (!base) { status.textContent = 'Vul de Xsolla Paystation URL in.'; return; }

    // Voeg metadata toe als query param (URI-encoded JSON). Als url al query params heeft, gebruik &
    const sep = base.includes('?') ? '&' : '?';
    const redirectUrl = base + sep + 'metadata=' + encodeURIComponent(JSON.stringify(metadata));

    // Open Xsolla (nieuw tabblad) — gebruiker voltooit betaling daar
    window.open(redirectUrl, '_blank');

    // Informeer gebruiker wat er moet gebeuren nadat betaald is
    status.innerHTML = 'Je wordt naar Xsolla gestuurd (nieuw tabblad). <br/>Na betaling moet jouw server Xsolla‑webhook verwerken en Miniclip (alleen met officiële toestemming) instrueren de skin toe te kennen.';
  });

  // recursieve zoekfunctie voor skins (zoals eerder)
  function findSkins(obj){
    const found = [];
    (function recurse(o){
      if (!o || typeof o !== 'object') return;
      // heuristiek: objecten met productId of skinType of image
      if (o.productId || o.skinType || o.image) {
        // verzamel relevante velden veilig
        found.push({
          productId: o.productId,
          skinType: o.skinType,
          gameplayId: o.gameplayId,
          image: o.image,
          price: o.price,
          cellColor: o.cellColor
        });
      }
      for (const k of Object.keys(o)) recurse(o[k]);
    })(obj);
    // dedupe by productId (optioneel)
    const seen = new Map();
    return found.filter(f=>{
      const key = f.productId || JSON.stringify(f);
      if (seen.has(key)) return false;
      seen.set(key, true);
      return true;
    });
  }

  // helpers: basic sanitize/escape to avoid injecting markup
  function escapeHtml(s){ if (!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function sanitizeImg(src){
    if (!src) return '';
    src = String(src);
    // relative image names in config: attempt to build full path relative to config URL host
    if (/^https?:\/\//i.test(src)) return encodeURI(src);
    try {
      const cfgUrl = new URL(document.getElementById('configUrl').value.trim());
      // create absolute url adjacent to config base, e.g. /live/v15/10850/<image>
      const basePath = cfgUrl.origin + cfgUrl.pathname.substring(0, cfgUrl.pathname.lastIndexOf('/')+1);
      return encodeURI(basePath + src);
    } catch(e) {
      return encodeURI(src);
    }
  }
})();
</script>
</body>
</html>

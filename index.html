<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>Game Helper</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
    :root {
        --bg-light: #f5f5f5;
        --bg-dark: #1e1e1e;
        --card-light: #ffffff;
        --card-dark: #2a2a2a;
        --text-light: #000000;
        --text-dark: #ffffff;
        --primary: #007bff;
    }
    body {
        margin: 0;
        font-family: 'Inter', sans-serif;
        background: var(--bg-light);
        color: var(--text-light);
        transition: 0.3s;
    }
    body.dark {
        background: var(--bg-dark);
        color: var(--text-dark);
    }
    .container {
        max-width: 520px;
        margin: 30px auto;
        background: var(--card-light);
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: 0.3s;
    }
    body.dark .container {
        background: var(--card-dark);
        box-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }
    h2 { margin-top: 0; text-align:center; }
    label { display:block; margin-top:12px; font-weight:500; }
    input, select, button, textarea {
        width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; margin-top:6px; font-size:14px; box-sizing:border-box;
    }
    button { background: var(--primary); color:#fff; border:none; font-weight:600; cursor:pointer; }
    .row { display:flex; gap:10px; margin-top:10px; }
    .small { font-size:12px; opacity:0.85; margin-top:10px; }
    .top-bar { display:flex; justify-content:space-between; margin-bottom:15px; align-items:center; }
    .lang-buttons button { width:auto; padding:6px 10px; margin-left:5px; border:1px solid #ccc; background:transparent; color:inherit; }
    .lang-buttons button.active { border-color:var(--primary); font-weight:600; }
    .theme-toggle { cursor:pointer; font-size:20px; user-select:none; }
    .warning { background:#fff3cd; color:#856404; border-radius:6px; padding:10px; margin-top:12px; border:1px solid #ffeeba; }
    .danger { background:#ffe6e6; color:#8b0000; border-radius:6px; padding:10px; margin-top:12px; border:1px solid #f5c6cb; font-weight:600; }
    .muted { opacity:0.85; font-size:13px; }
</style>
</head>
<body>
<div class="container">
    <div class="top-bar">
        <div class="lang-buttons">
            <button id="lang-nl" class="active">🇳🇱 NL</button>
            <button id="lang-en">🇬🇧 EN</button>
        </div>
        <div class="theme-toggle" id="themeToggle">🌙</div>
    </div>

    <h2 id="title">Start een Game Helper</h2>

    <label id="label-uid">Console ID / Skin Key (UID)</label>
    <input id="uid" placeholder="Plak je UID hier" autocomplete="off" inputmode="text">

    <label><input type="checkbox" id="hideKey" checked> <span id="label-hidekey">Verberg geheime sleutel</span></label>

    <!-- New: explicit confirmation to use raw UID -->
    <div class="warning" id="rawWarning">
        <div style="font-weight:600;">Belangrijk — raw UID gebruik</div>
        <div class="muted" style="margin-top:6px;">
            Als je je echte UID wilt gebruiken (bijvoorbeeld: <code>66464ffd-a57c-496c-b60f-79ecc0d82a4a</code>),
            vink dan hieronder de bevestiging aan. De raw UID wordt <strong>niet</strong> opgeslagen in localStorage en
            wordt alleen direct naar de server gestuurd wanneer jij expliciet bevestigt dat dit jouw eigen account is.
        </div>
    </div>

    <label style="margin-top:10px;"><input type="checkbox" id="confirmRaw"> <strong>Ik bevestig dat dit mijn eigen Agar.io UID is en ik geef toestemming om deze éénmalig te gebruiken</strong></label>

    <div class="row">
        <button id="verifyBtn">Controleer & Koppel UID</button>
    </div>

    <div id="status" style="margin-top:10px; font-weight:500;"></div>
    <div id="warning" style="display:none; margin-top:8px;" class="danger"></div>

    <label id="label-region">Kies Bot Regio</label>
    <select id="region">
        <option>ME South 1</option>
        <option>EU West</option>
        <option>US East</option>
    </select>

    <label id="label-mode">Kies Bot Game Modus</label>
    <select id="mode">
        <option>Burst</option>
        <option>Classic</option>
    </select>

    <label id="label-botname">Bot Naam invullen</label>
    <input id="botName" placeholder="bijv. T.B">

    <label id="label-party">Bot Party (link)</label>
    <input id="party" placeholder="https://r.agar.io/?party=...">

    <button id="startBotBtn" style="margin-top:14px;">Start Bot</button>

    <p class="small" id="note">Standaard: alleen een hash van je UID wordt gebruikt. Raw UID wordt alleen gebruikt wanneer je expliciet bevestigt.</p>
</div>

<script>
/* Taal, thema, en helpers (zelfde pattern als eerder) */
const translations = {
  en: {
    title: "Start a Game Helper",
    uid: "Console ID / Skin Key (UID)",
    hideKey: "Hide secret key",
    verify: "Check & Link UID",
    region: "Choose Bot Region",
    mode: "Set Bot Game Mode",
    botName: "Put Bot Name",
    party: "Put Bot Party (link)",
    start: "Start Bot",
    note: "By default only a hash of your UID is used. Raw UID is only used with explicit confirmation.",
    placeholderUid: "Paste your UID here",
    placeholderBotName: "e.g. T.B",
    placeholderParty: "https://r.agar.io/?party=...",
    errorNoUid: "Please enter a UID first.",
    multipleUids: "Multiple UID-like strings detected. Using the first one found.",
    confirmRawLabel: "I confirm this is my own Agar.io UID and I consent to using it once."
  },
  nl: {
    title: "Start een Game Helper",
    uid: "Console ID / Skin Key (UID)",
    hideKey: "Verberg geheime sleutel",
    verify: "Controleer & Koppel UID",
    region: "Kies Bot Regio",
    mode: "Kies Bot Game Modus",
    botName: "Bot Naam invullen",
    party: "Bot Party (link)",
    start: "Start Bot",
    note: "Standaard: alleen een hash van je UID wordt gebruikt. Raw UID wordt alleen gebruikt met expliciete bevestiging.",
    placeholderUid: "Plak je UID hier",
    placeholderBotName: "bijv. T.B",
    placeholderParty: "https://r.agar.io/?party=...",
    errorNoUid: "Voer eerst een UID in.",
    multipleUids: "Meerdere UID-achtige strings gedetecteerd. Gebruik de eerste.",
    confirmRawLabel: "Ik bevestig dat dit mijn eigen Agar.io UID is en ik geef toestemming om deze éénmalig te gebruiken."
  }
};

let currentLang = localStorage.getItem('lang') || 'nl';
let linkedUser = JSON.parse(localStorage.getItem('linkedUser') || 'null');

function applyLanguage() {
    const t = translations[currentLang];
    document.getElementById('title').textContent = t.title;
    document.getElementById('label-uid').textContent = t.uid;
    document.getElementById('label-hidekey').textContent = t.hideKey;
    document.getElementById('verifyBtn').textContent = t.verify;
    document.getElementById('label-region').textContent = t.region;
    document.getElementById('label-mode').textContent = t.mode;
    document.getElementById('label-botname').textContent = t.botName;
    document.getElementById('label-party').textContent = t.party;
    document.getElementById('startBotBtn').textContent = t.start;
    document.getElementById('note').textContent = t.note;
    document.getElementById('uid').placeholder = t.placeholderUid;
    document.getElementById('botName').placeholder = t.placeholderBotName;
    document.getElementById('party').placeholder = t.placeholderParty;
    // confirm raw label (text inside the confirmation checkbox)
    const confirmLabel = document.querySelector('label[style*="margin-top:10px;"]');
    if (confirmLabel) confirmLabel.innerHTML = `<input type="checkbox" id="confirmRaw"> <strong>${t.confirmRawLabel}</strong>`;
}
applyLanguage();

/* Theme toggle */
document.getElementById('themeToggle').onclick = () => {
    document.body.classList.toggle('dark');
    document.getElementById('themeToggle').textContent = document.body.classList.contains('dark') ? '☀️' : '🌙';
};

/* Mask input if hideKey checked */
const uidInput = document.getElementById('uid');
const hideKeyCheckbox = document.getElementById('hideKey');
hideKeyCheckbox.addEventListener('change', () => {
    uidInput.type = hideKeyCheckbox.checked ? 'password' : 'text';
});
uidInput.type = hideKeyCheckbox.checked ? 'password' : 'text';

/* Helpers: extract UUID-like substrings and sha256 */
function extractUUIDs(text) {
    if (!text) return [];
    const regex = /[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}/g;
    return text.match(regex) || [];
}

async function sha256Hex(message) {
    const encoder = new TextEncoder();
    const data = encoder.encode(message);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

/* Simple POST helper */
async function postJSON(url, data) {
    const res = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    return await res.json();
}

/* UI elements */
const statusDiv = document.getElementById('status');
const dangerDiv = document.getElementById('warning');
const confirmRawCheckbox = () => document.getElementById('confirmRaw');

/* Behavior for "Check & Link UID" */
document.getElementById('verifyBtn').onclick = async () => {
    dangerDiv.style.display = 'none';
    const raw = uidInput.value.trim();
    if (!raw) {
        statusDiv.textContent = translations[currentLang].errorNoUid;
        return;
    }
    statusDiv.textContent = "Bezig...";
    try {
        const found = extractUUIDs(raw);
        let uidToUse = raw;
        if (found.length >= 1) {
            if (found.length > 1) {
                dangerDiv.textContent = translations[currentLang].multipleUids;
                dangerDiv.style.display = 'block';
            }
            uidToUse = found[0];
        }

        // If user confirmed raw usage, send raw UID (but do NOT store it).
        if (confirmRawCheckbox() && confirmRawCheckbox().checked) {
            // explicit consent path
            // send raw UID once and do not keep it in localStorage
            const resp = await postJSON('/api/verify-uid', { uidRaw: uidToUse });
            if (resp.ok) {
                linkedUser = { id: resp.user.id, uidHash: await sha256Hex(uidToUse), display: resp.user.display || null };
                // store only hash and id — NOT the raw UID
                localStorage.setItem('linkedUser', JSON.stringify({ id: linkedUser.id, uidHash: linkedUser.uidHash, display: linkedUser.display }));
                statusDiv.textContent = "✅ UID gekoppeld (raw gebruikt)! User ID: " + resp.user.id;
            } else {
                statusDiv.textContent = "❌ " + (resp.message || "Verificatie mislukt.");
            }
            // clear raw input immediately after use
            uidInput.value = '';
        } else {
            // secure default path: hash client-side and send hash
            const hashed = await sha256Hex(uidToUse);
            const resp = await postJSON('/api/verify-uid', { uidHash: hashed });
            if (resp.ok) {
                linkedUser = { id: resp.user.id, uidHash: hashed, display: resp.user.display || null };
                localStorage.setItem('linkedUser', JSON.stringify({ id: linkedUser.id, uidHash: linkedUser.uidHash, display: linkedUser.display }));
                statusDiv.textContent = "✅ UID gekoppeld (hash gebruikt)! User ID: " + resp.user.id;
            } else {
                statusDiv.textContent = "❌ " + (resp.message || "Verificatie mislukt.");
            }
        }
    } catch (e) {
        console.error(e);
        statusDiv.textContent = "❌ Server error";
    }
};

/* Start bot: if raw UID was just used and not stored, we allow passing raw UID from current input
   only when user re-checks confirmRaw. Otherwise pass stored uidHash. */
document.getElementById('startBotBtn').onclick = async () => {
    dangerDiv.style.display = 'none';
    if (!linkedUser) {
        statusDiv.textContent = "❌ UID niet gekoppeld.";
        return;
    }

    const payload = {
        userId: linkedUser.id,
        uidHash: linkedUser.uidHash, // default
        botName: document.getElementById('botName').value.trim(),
        region: document.getElementById('region').value,
        mode: document.getElementById('mode').value,
        party: document.getElementById('party').value.trim()
    };

    // If user currently confirms raw UID and there's something in the input, allow sending rawUID instead of hash.
    const rawCandidate = uidInput.value.trim();
    if (confirmRawCheckbox() && confirmRawCheckbox().checked && rawCandidate) {
        // extract/normalize
        const found = extractUUIDs(rawCandidate);
        const uidToUse = (found.length ? found[0] : rawCandidate);
        // include rawUID only if user explicitly confirmed
        payload.uidRaw = uidToUse;
        // still include uidHash for server-side reference
        payload.uidHash = await sha256Hex(uidToUse);
        // clear input after use
        uidInput.value = '';
    }

    statusDiv.textContent = "...";
    try {
        const resp = await postJSON('/api/start-bot', payload);
        if (resp.ok) {
            statusDiv.textContent = "✅ Bot gestart! Session ID: " + resp.sessionId;
        } else {
            statusDiv.textContent = "❌ " + (resp.message || "Kon bot niet starten.");
        }
    } catch (e) {
        console.error(e);
        statusDiv.textContent = "❌ Server error";
    }
};
</script>
</body>
</html>
